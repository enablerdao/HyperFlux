<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HyperFlux.io - ブロックチェーンモニター</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #212529;
        }
        .header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
            border: none;
        }
        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
        }
        .stats-value {
            font-size: 2rem;
            font-weight: 700;
            color: #6a11cb;
        }
        .stats-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
        .transaction-card {
            transition: all 0.3s ease;
        }
        .transaction-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }
        #tps-chart {
            height: 300px;
        }
        .footer {
            margin-top: 3rem;
            padding: 1.5rem 0;
            background-color: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="display-4">HyperFlux.io</h1>
                    <p class="lead">トランザクションが川の流れのように速く、スムーズに動くブロックチェーン。</p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="d-flex justify-content-end align-items-center">
                        <div class="me-3">
                            <div class="stats-label">ノード状態</div>
                            <div id="node-status" class="badge bg-success">Running</div>
                        </div>
                        <div>
                            <div class="stats-label">ノードID</div>
                            <div id="node-id" class="small text-truncate" style="max-width: 150px;">loading...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body text-center">
                        <div class="stats-label">現在のTPS</div>
                        <div id="current-tps" class="stats-value">0</div>
                        <div class="small text-muted">トランザクション/秒</div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body text-center">
                        <div class="stats-label">シャード数</div>
                        <div id="shard-count" class="stats-value">256</div>
                        <div class="small text-muted">動的に調整中</div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body text-center">
                        <div class="stats-label">確認済みトランザクション</div>
                        <div id="confirmed-tx" class="stats-value">0</div>
                        <div class="small text-muted">合計</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        TPSの推移
                    </div>
                    <div class="card-body">
                        <canvas id="tps-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>新規トランザクション作成</span>
                    </div>
                    <div class="card-body">
                        <form id="tx-form">
                            <div class="mb-3">
                                <label for="parent-ids" class="form-label">親トランザクションID（カンマ区切り）</label>
                                <input type="text" class="form-control" id="parent-ids" placeholder="例: id1,id2,id3">
                            </div>
                            <div class="mb-3">
                                <label for="payload" class="form-label">ペイロード</label>
                                <textarea class="form-control" id="payload" rows="3" placeholder="トランザクションデータを入力"></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="signature" class="form-label">署名</label>
                                <input type="text" class="form-control" id="signature" placeholder="署名を入力（デモ用にランダム生成されます）">
                            </div>
                            <button type="submit" class="btn btn-primary">トランザクション作成</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        最近のトランザクション
                    </div>
                    <div class="card-body">
                        <div id="recent-transactions" class="row">
                            <!-- トランザクションはJSで動的に追加 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-0">© 2024 HyperFlux.io - 高性能ブロックチェーン</p>
                </div>
                <div class="col-md-6 text-end">
                    <p class="mb-0">Proof of Flow (PoF) コンセンサス</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // ノード情報を取得する関数（Netlifyデモ用にモック）
        async function fetchNodeInfo() {
            try {
                // モックデータ
                const data = {
                    id: 'node-' + Math.random().toString(36).substring(2, 10),
                    status: 'Running',
                    tps: Math.random() * 1000 + 500,
                    shard_count: 256,
                    confirmed_transactions: Math.floor(Math.random() * 10000)
                };
                
                // UI更新
                document.getElementById('node-id').textContent = data.id;
                document.getElementById('node-status').textContent = data.status;
                document.getElementById('current-tps').textContent = data.tps.toFixed(2);
                document.getElementById('shard-count').textContent = data.shard_count;
                document.getElementById('confirmed-tx').textContent = data.confirmed_transactions;
                
                // チャートデータ更新
                addDataToChart(tpsChart, new Date().toLocaleTimeString(), data.tps);
                
                return data;
            } catch (error) {
                console.error('Error fetching node info:', error);
                document.getElementById('node-status').textContent = 'Offline';
                document.getElementById('node-status').className = 'badge bg-danger';
            }
        }
        
        // トランザクションを作成する関数（Netlifyデモ用にモック）
        async function createTransaction(parentIds, payload, signature) {
            try {
                // モックデータ
                const data = {
                    id: Math.random().toString(36).substring(2, 10) + '-' + Date.now(),
                    status: 'success'
                };
                
                // 成功時の処理
                addTransactionToUI(data.id, payload, new Date().toISOString());
                return data;
            } catch (error) {
                console.error('Error creating transaction:', error);
                alert('トランザクション作成中にエラーが発生しました。');
                return null;
            }
        }
        
        // UIにトランザクションを追加
        function addTransactionToUI(id, payload, timestamp) {
            const container = document.getElementById('recent-transactions');
            
            // 新しいトランザクションカードを作成
            const txCard = document.createElement('div');
            txCard.className = 'col-md-6 mb-3';
            txCard.innerHTML = `
                <div class="card transaction-card">
                    <div class="card-body">
                        <h6 class="card-title text-truncate" title="${id}">ID: ${id.substring(0, 8)}...</h6>
                        <p class="card-text small text-truncate">${payload}</p>
                        <div class="d-flex justify-content-between">
                            <span class="badge bg-success">確認済み</span>
                            <small class="text-muted">${new Date(timestamp).toLocaleTimeString()}</small>
                        </div>
                    </div>
                </div>
            `;
            
            // 最大10件まで表示
            if (container.children.length >= 10) {
                container.removeChild(container.lastChild);
            }
            
            // 先頭に追加
            container.insertBefore(txCard, container.firstChild);
        }
        
        // チャートにデータを追加
        function addDataToChart(chart, label, data) {
            chart.data.labels.push(label);
            chart.data.datasets[0].data.push(data);
            
            // 最大20ポイントまで表示
            if (chart.data.labels.length > 20) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
            }
            
            chart.update();
        }
        
        // ランダムな16進数文字列を生成
        function generateRandomHex(length) {
            const chars = '0123456789abcdef';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars[Math.floor(Math.random() * chars.length)];
            }
            return result;
        }
        
        // TPSチャートの初期化
        const ctx = document.getElementById('tps-chart').getContext('2d');
        const tpsChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'TPS',
                    data: [],
                    borderColor: '#6a11cb',
                    backgroundColor: 'rgba(106, 17, 203, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
        
        // フォーム送信イベントリスナー
        document.getElementById('tx-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const parentIdsInput = document.getElementById('parent-ids').value;
            const payload = document.getElementById('payload').value;
            let signature = document.getElementById('signature').value;
            
            // 親IDをパース
            const parentIds = parentIdsInput ? parentIdsInput.split(',').map(id => id.trim()) : [];
            
            // 署名が空の場合はランダム生成
            if (!signature) {
                signature = generateRandomHex(64);
                document.getElementById('signature').value = signature;
            }
            
            // トランザクション作成
            await createTransaction(parentIds, payload, signature);
        });
        
        // 初期データ取得
        fetchNodeInfo();
        
        // 定期的にデータを更新（5秒ごと）
        setInterval(fetchNodeInfo, 5000);
        
        // デモ用にサンプルトランザクションを追加
        addTransactionToUI(
            generateRandomHex(32),
            'サンプルトランザクション1',
            new Date().toISOString()
        );
        addTransactionToUI(
            generateRandomHex(32),
            'サンプルトランザクション2',
            new Date(Date.now() - 60000).toISOString()
        );
    </script>
</body>
</html>